public class NeustartApiManager {
   
    public static Neustar_Data__c makeApiCall(String phoneNumber){ 
        If(String.isNotBlank(phoneNumber)){
            phoneNumber = phoneNumber.replaceAll('[^a-zA-Z0-9\\s+]', '');
            phoneNumber= phoneNumber.replaceAll( '\\s+', '');
        }
        
        apiPortpsNeustarBizPortpsServicesB.TNListType ap = new apiPortpsNeustarBizPortpsServicesB.TNListType();
        
        ap.TelephoneNumber = new List<String>{phoneNumber}; // '5702474247'
            
        apiPortpsNeustarBizPortpsServicesB.BasicSearchServiceBinding api = new apiPortpsNeustarBizPortpsServicesB.BasicSearchServiceBinding();
        apiPortpsNeustarBizPortpsServicesB.BasicSearchResponse_element resp = api.BasicSearchInformation(null,null,'?','Y',ap);
        
        NeustarWrapper nw;
        Neustar_Data__c nd = new Neustar_Data__c();
        if(resp.ResponseMessage == 'Invalid Telephone numbers' || resp.ResponseMessage =='At least one Telephone Number must be present in request') return null;
        else if((resp.ResponseMessage == 'Processed' && resp.TnResponseList != null && resp.TnResponseList.TNResponse != null && resp.TnResponseList.TNResponse[0].Ownership.Status.containsIgnoreCase('NPA not found'))) return null;
        else if(Test.isRunningTest() || (resp.ResponseMessage == 'Processed' && resp.TnResponseList.TNResponse != null && !resp.TnResponseList.TNResponse[0].Ownership.Status.containsIgnoreCase('NPA not found'))){
            if(Test.isRunningTest()) nw = NeustarWrapper.parse('{"TNResponse":[{"Routing_type_info":["Routing","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"Routing":{"WsmscDpcSsn_type_info":["WsmscDpcSsn","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"WsmscDpcSsn":"","Lrn_type_info":["Lrn","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"Lrn":"5702650088","LidbDpcSsn_type_info":["LidbDpcSsn","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"LidbDpcSsn":"238013000-000","IsvmDpcSsn_type_info":["IsvmDpcSsn","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"IsvmDpcSsn":"235235001-000","field_order_type_info":["Lrn","ClassDpcSsn","LidbDpcSsn","IsvmDpcSsn","CnamDpcSsn","WsmscDpcSsn"],"CnamDpcSsn_type_info":["CnamDpcSsn","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"CnamDpcSsn":"238013000-000","ClassDpcSsn_type_info":["ClassDpcSsn","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"ClassDpcSsn":"235235001-000","apex_schema_type_info":["https://api-portps.neustar.biz/portps/services/BasicSearchService/","false","false"]},"PortingHistory_type_info":["PortingHistory","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","100","false"],"PortingHistory":null,"Ownership_type_info":["Ownership","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"1","1","false"],"Ownership":{"SvType_type_info":["SvType","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"SvType":"Wireline","Status_type_info":["Status","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"Status":"Ported - Intra","PhoneNumber_type_info":["PhoneNumber","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"PhoneNumber":"5702474247","NpacSpid_type_info":["NpacSpid","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"NpacSpid":"0161","NanpaOcn_type_info":["NanpaOcn","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"NanpaOcn":"0161","LastAltSpid_type_info":["LastAltSpid","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"LastAltSpid":"","field_order_type_info":["PhoneNumber","Status","NpacSpid","Company","AltSpid","LastAltSpid","NanpaOcn","SvType"],"Company_type_info":["Company","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"Company":"FrontierPA_CTCO:0161 - NSR/1","apex_schema_type_info":["https://api-portps.neustar.biz/portps/services/BasicSearchService/","false","false"],"AltSpid_type_info":["AltSpid","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"AltSpid":""},"IpFields_type_info":["IpFields","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"IpFields":{"VoiceUri_type_info":["VoiceUri","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"VoiceUri":"","SmsUri_type_info":["SmsUri","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"SmsUri":"","MmsUri_type_info":["MmsUri","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"MmsUri":"","field_order_type_info":["VoiceUri","MmsUri","SmsUri"],"apex_schema_type_info":["https://api-portps.neustar.biz/portps/services/BasicSearchService/","false","false"]},"Geography_type_info":["Geography","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"Geography":{"State_type_info":["State","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"State":"Pennsylvania","Region_type_info":["Region","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"Region":"Mid-Atlantic","RateCenter_type_info":["RateCenter","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"RateCenter":"ROME","Longitude_type_info":["Longitude","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"Longitude":"-76.44","Latitude_type_info":["Latitude","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"Latitude":"41.78","Lata_type_info":["Lata","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"Lata":"232 - NORTHEAST - PA","field_order_type_info":["Region","State","Lata","RateCenter","Latitude","Longitude"],"apex_schema_type_info":["https://api-portps.neustar.biz/portps/services/BasicSearchService/","false","false"]},"field_order_type_info":["Ownership","Geography","Routing","CodeBlockInfo","AdditionalFields","IpFields","PortingHistory"],"CodeBlockInfo_type_info":["CodeBlockInfo","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"CodeBlockInfo":{"PasBlockOwnerStatus_type_info":["PasBlockOwnerStatus","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"PasBlockOwnerStatus":"Assigned","PasBlockOwnerOcnName_type_info":["PasBlockOwnerOcnName","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"PasBlockOwnerOcnName":"CORE COMMUNICATIONS, INC. - PA","PasBlockOwnerOcn_type_info":["PasBlockOwnerOcn","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"PasBlockOwnerOcn":"3806","PasBlockOwnerEffectiveDate_type_info":["PasBlockOwnerEffectiveDate","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"PasBlockOwnerEffectiveDate":"03/27/2019 12:00 AM, EDT","NpacCodeOwnerSpidName_type_info":["NpacCodeOwnerSpidName","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"NpacCodeOwnerSpidName":"FrontierPA_CTCO:0161 - NSR/1","NpacCodeOwnerSpid_type_info":["NpacCodeOwnerSpid","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"NpacCodeOwnerSpid":"0161","NanpaCodeOwnerOcnName_type_info":["NanpaCodeOwnerOcnName","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"NanpaCodeOwnerOcnName":"COMMONWEALTH TELEPHONE COMPANY LLC","NanpaCodeOwnerOcn_type_info":["NanpaCodeOwnerOcn","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"NanpaCodeOwnerOcn":"0161","IlecRbocOcnName_type_info":["IlecRbocOcnName","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"IlecRbocOcnName":"LERG/DIR Listing Required","IlecRbocOcn_type_info":["IlecRbocOcn","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"IlecRbocOcn":"LERG/DIR Listing Required","field_order_type_info":["NanpaCodeOwnerOcn","NanpaCodeOwnerOcnName","PasBlockOwnerOcn","PasBlockOwnerOcnName","PasBlockOwnerStatus","PasBlockOwnerEffectiveDate","NpacCodeOwnerSpid","NpacCodeOwnerSpidName","IlecRbocOcn","IlecRbocOcnName"],"apex_schema_type_info":["https://api-portps.neustar.biz/portps/services/BasicSearchService/","false","false"]},"apex_schema_type_info":["https://api-portps.neustar.biz/portps/services/BasicSearchService/","false","false"],"AdditionalFields_type_info":["AdditionalFields","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"AdditionalFields":{"field_order_type_info":["BillingId","EndUserLocation","EndUserLocationType"],"EndUserLocationType_type_info":["EndUserLocationType","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"EndUserLocationType":"","EndUserLocation_type_info":["EndUserLocation","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"EndUserLocation":"","BillingId_type_info":["BillingId","https://api-portps.neustar.biz/portps/services/BasicSearchService/",null,"0","1","false"],"BillingId":"","apex_schema_type_info":["https://api-portps.neustar.biz/portps/services/BasicSearchService/","false","false"]}}]}');
            else nw = NeustarWrapper.parse('{"TNResponse":'+JSON.serialize(resp.TnResponseList.TNResponse)+'}');
            
            //system.debug('test :: '+'{"TNResponse":'+JSON.serialize(resp.TnResponseList.TNResponse)+'}');
            if(nw.TNResponse == null || nw.TNResponse.size() == 0) return null;
            
            nd.TN__c = phoneNumber;
            if(nw.TNResponse != null && nw.TNResponse.size() > 0 && nw.TNResponse[0].Geography != null){
                nd.Region__c  = nw.TNResponse[0].Geography.Region;
                nd.State1__c = nw.TNResponse[0].Geography.State;
                nd.LATA_Name__c = nw.TNResponse[0].Geography.Lata;
                nd.Rate_Center__c = nw.TNResponse[0].Geography.RateCenter;    
            }
            if(nw.TNResponse != null && nw.TNResponse.size() > 0 && nw.TNResponse[0].Routing != null)
                nd.TN_LRN__c = nw.TNResponse[0].Routing.Lrn; 
            if(nw.TNResponse != null && nw.TNResponse.size() > 0 && nw.TNResponse[0].CodeBlockInfo != null){
                nd.Current_SPID__c =  nw.TNResponse[0].CodeBlockInfo.NpacCodeOwnerSpid;
                nd.Current_SP__c =  nw.TNResponse[0].CodeBlockInfo.NpacCodeOwnerSpidName;
            }
            //system.debug('PortingHistory :: '+resp.TnResponseList.TNResponse[0].PortingHistory);
            if(resp.TnResponseList != null && resp.TnResponseList.TNResponse != null && resp.TnResponseList.TNResponse[0].PortingHistory != null && 
              resp.TnResponseList.TNResponse[0].PortingHistory.size() > 0 && resp.TnResponseList.TNResponse[0].PortingHistory[0].PortingInfo !=null && 
              resp.TnResponseList.TNResponse[0].PortingHistory[0].PortingInfo.size() > 0){
                
                  if(resp.TnResponseList.TNResponse[0].PortingHistory[0].PortingInfo[0].Date_x != null)
                    nd.Port_Date__c = Date.valueOf(resp.TnResponseList.TNResponse[0].PortingHistory[0].PortingInfo[0].Date_x);
                  nd.Port_Activity_Type__c  = resp.TnResponseList.TNResponse[0].PortingHistory[0].PortingInfo[0].Event;
                  nd.Old_SPID__c   = resp.TnResponseList.TNResponse[0].PortingHistory[0].PortingInfo[0].NpacSpid;
                  nd.Old_SP__c  = resp.TnResponseList.TNResponse[0].PortingHistory[0].PortingInfo[0].NpacSpidCompanyName;
            }
            //&& nw.TNResponse[0].PortingHistory[0].PortingInfo.size() > 0
        }
        return nd;
    }
}